name: PR Merge Build and Notify

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  build:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # CodeQL 분석을 위해 전체 히스토리 가져오기

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build
        id: build
        continue-on-error: true  # 빌드 실패 시에도 워크플로우 계속 진행 (Slack 알림용)

      # 빌드 성공 시에만 CodeQL 분석 실행
      - name: Initialize CodeQL
        if: steps.build.outcome == 'success'
        uses: github/codeql-action/init@v2
        with:
          languages: java  # 필요에 따라 javascript, python 등 추가 가능

      - name: Perform CodeQL Analysis
        if: steps.build.outcome == 'success'
        uses: github/codeql-action/analyze@v2
        id: codeql
        continue-on-error: true  # CodeQL 실패 시에도 워크플로우 계속 진행 (Slack 알림용)

      # 빌드 실패 시 Slack 알림
      - name: Notify Slack on Build Failure
        if: steps.build.outcome == 'failure'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "#ff0000", 
                  "title": "${{ github.repository }}", 
                  "title_link": "https://github.com/${{github.repository}}", 
                  "text": "PR Merge 후 빌드 실패 :x:",
                  "fields": [
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "PR Title",
                      "value": "${{ github.event.pull_request.title }}",
                      "short": true
                    },
                    {
                      "title": "Merged By",
                      "value": "${{ github.event.pull_request.merged_by.login }}",
                      "short": true
                    },
                    {
                      "title": "Workflow",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>",
                      "short": false
                    }
                  ]      
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      # CodeQL 분석 실패 시 Slack 알림
      - name: Notify Slack on CodeQL Failure
        if: steps.build.outcome == 'success' && steps.codeql.outcome == 'failure'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "#ff9900", 
                  "title": "${{ github.repository }}", 
                  "title_link": "https://github.com/${{github.repository}}", 
                  "text": "PR Merge 후 CodeQL 분석 실패 :warning:",
                  "fields": [
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "PR Title",
                      "value": "${{ github.event.pull_request.title }}",
                      "short": true
                    },
                    {
                      "title": "Merged By",
                      "value": "${{ github.event.pull_request.merged_by.login }}",
                      "short": true
                    },
                    {
                      "title": "Workflow",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>",
                      "short": false
                    }
                  ]      
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      # 모든 작업 성공 시 Slack 알림
      - name: Notify Slack on Success
        if: steps.build.outcome == 'success' && (steps.codeql.outcome == 'success' || steps.codeql.outcome == 'skipped')
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "#36a64f", 
                  "title": "${{ github.repository }}", 
                  "title_link": "https://github.com/${{github.repository}}", 
                  "text": "PR Merge 후 빌드 및 CodeQL 분석 성공 :white_check_mark:",
                  "fields": [
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "PR Title",
                      "value": "${{ github.event.pull_request.title }}",
                      "short": true
                    },
                    {
                      "title": "Merged By",
                      "value": "${{ github.event.pull_request.merged_by.login }}",
                      "short": true
                    },
                    {
                      "title": "Workflow",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>",
                      "short": false
                    }
                  ]      
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
