name: PR Code Quality and AI Summary

on:
  pull_request:
    types: [ opened, synchronize ]  # PRì´ ì—´ë¦¬ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ íŠ¸ë¦¬ê±°

permissions:
  contents: read  # ë¦¬í¬ì§€í† ë¦¬ì˜ ì½˜í…ì¸ ë¥¼ ì½ì„ ìˆ˜ ìˆìŒ
  pull-requests: write  # PRì— ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŒ
  checks: write

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v1
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Build and Test Backend
        id: build
        run: ./gradlew build test
        continue-on-error: true

  code-quality:
    needs: build-test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tool: [ checkstyle, pmd, spotbugs, jacoco ]
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run Checkstyle
        if: matrix.tool == 'checkstyle'
        run: ./gradlew checkstyleMain checkstyleTest
      - name: Publish Checkstyle report
        if: matrix.tool == 'checkstyle'
        uses: lcollins/checkstyle-github-action@v3.1.0
        with:
          path: '**/build/reports/checkstyle/**.xml'
          title: ğŸ“ Checkstyle report

      - name: Run PMD
        if: matrix.tool == 'pmd'
        run: ./gradlew pmdMain pmdTest
      - name: Publish PMD report
        if: matrix.tool == 'pmd'
        uses: lcollins/pmd-github-action@v3.1.0
        with:
          path: '**/build/reports/pmd/**.xml'
          title: ğŸ” PMD report

      - name: Run SpotBugs
        if: matrix.tool == 'spotbugs'
        run: ./gradlew spotbugsMain spotbugsTest
      - name: Publish SpotBugs report
        if: matrix.tool == 'spotbugs'
        uses: lcollins/spotbugs-github-action@v3.1.0
        with:
          path: '**/build/reports/spotbugs/**.xml'
          title: ğŸ SpotBugs report

      - name: Run JaCoCo
        if: matrix.tool == 'jacoco'
        run: ./gradlew jacocoTestReport
      - name: Publish JaCoCo report
        if: matrix.tool == 'jacoco'
        uses: PavanMudigonda/jacoco-reporter@v5.0
        with:
          coverage_results_path: 'build/reports/jacoco/test/jacocoTestReport.xml'
          coverage_report_name: Coverage
          coverage_report_title: ğŸ“– JaCoCo Coverage Report

  ai-summary:
    needs: code-quality  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ í›„ ì‹¤í–‰ë¨
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'  # ìµœì‹  Node.js ë²„ì „ ì„¤ì •

      - name: Install Dependencies
        run: npm install @google/generative-ai

      - name: Generate AI Review
        id: generate-review
        run: |
          node -e "
          const fs = require('fs');
          const { GoogleGenerativeAI } = require('@google/generative-ai');

          const readReport = (filePath) => {
            try {
              return fs.readFileSync(filePath, 'utf8');
            } catch (error) {
              console.error(\`Error reading \${filePath}:\`, error);
              return '';
            }
          };

          const reports = {
            checkstyle: readReport('build/reports/checkstyle/main.xml'),
            pmd: readReport('build/reports/pmd/main.xml'),
            spotbugs: readReport('build/reports/spotbugs/main.xml'),
            jacoco: readReport('build/reports/jacoco/test/jacocoTestReport.xml'),
          };

          const { GoogleGenerativeAI } = require("@google/generative-ai");
          const genAI = new GoogleGenerativeAI("${{ secrets.GEMINI_API_KEY }}");  // Gemini API í‚¤ë¡œ ìƒì„±ì ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
          const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });  // Gemini ëª¨ë¸ ì„¤ì •

          const prompt = \`
            ë‹¤ìŒ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.
            - Checkstyle:\n\${reports.checkstyle}
            - PMD:\n\${reports.pmd}
            - SpotBugs:\n\${reports.spotbugs}
            - JaCoCo:\n\${reports.jacoco}

            ì£¼ìš” ë¬¸ì œì  ì •ë¦¬, ê°œì„ ì‚¬í•­ ì œì‹œ, ì¢…í•© í‰ê°€ë¥¼ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
          \`;

          async function generateReview() {
            try {
              const result = await model.generateContent(prompt);
              const response = await result.response;
              const text = await response.text();

              if (!text || text.trim().length === 0) {
                console.log('âŒ Gemini API ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
                throw new Error('Gemini API ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
              }

              fs.writeFileSync('review_result.txt', text);
              console.log('âœ… Gemini API ì‘ë‹µì„ review_result.txt íŒŒì¼ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
              console.error('âŒ Gemini API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
              process.exit(1);
            }
          }

          generateReview();
          "

      - name: Format PR Review Summary for Comment
        id: store-comment
        run: |
          COMMENT_STRING=$(cat review_result.txt)

          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "# ì½”ë“œ í’ˆì§ˆ AI PR ìš”ì•½" >> $GITHUB_OUTPUT
          echo "$COMMENT_STRING" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post PR Summary Comment
        uses: mshick/add-pr-comment@v2
        with:
          message: ${{ steps.store-comment.outputs.comment }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
